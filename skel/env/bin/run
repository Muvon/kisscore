#!/bin/bash
pid_file=$RUN_DIR/run.pid
if [[ -f $pid_file ]]; then 
  pid=$(cat $pid_file)
  if ps -p $pid > /dev/null; then
    exit 1
  fi
fi
echo -n $$ > $pid_file

function kill_subshells {
  for file in $(/bin/ls -I $pid_file $RUN_DIR/*.pid); do
    cat $file | xargs pkill -SIGTERM -P
  done

  for pid in ${PIDS[@]}; do
    pkill -SIGTERM -P $pid
  done
  wait
  exit 0
}

trap kill_subshells SIGINT SIGTERM
while true; do
  if [[ ! -f $CONFIG_DIR/tasks ]]; then
    echo 'File with tasks to be run not found'
    exit 1
  fi

  readarray TASKS < $CONFIG_DIR/tasks
  for i in "${!TASKS[@]}"; do
    if [[ ${PIDS[$i]+isset} && $(ps -p ${PIDS[$i]} -o pid | sed 1d) ]]; then
      continue
    fi
    cmd=${TASKS[$i]%% \#*}
    ( bash -c "$cmd" ) & PIDS[$i]=$!
  done
  sleep 5
done
