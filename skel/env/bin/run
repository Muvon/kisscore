#!/bin/bash
pid_file=$RUN_DIR/run.pid
if [[ -f $pid_file ]]; then 
  pid=$(cat $pid_file)
  if ps -p $pid > /dev/null; then
    exit 1
  fi
fi
echo -n $$ > $pid_file

trap "pgrep -P $$ | while read process; do pkill -SIGTERM -P \$process; kill \$process; done; wait; exit 0" SIGINT SIGTERM
while true; do
  if [[ ! -f $CONFIG_DIR/tasks ]]; then
    echo 'File with tasks to be run not found'
    exit 1
  fi

  readarray TASKS < $CONFIG_DIR/tasks
  for i in "${!TASKS[@]}"; do
    if [[ ${PIDS[$i]+isset} && $(ps -p ${PIDS[$i]} -o pid | sed 1d) ]]; then
      continue
    fi
    cmd=${TASKS[$i]%% \#*}
    ( bash -c "$cmd" ) & PIDS[$i]=$!
  done
  sleep 5
done
