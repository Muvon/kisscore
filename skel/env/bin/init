#!/bin/bash
echo 'Initialization started'

echo '+Configure and compile project'
php-exec 'App::compile()'
echo '...done'

echo '+Reloading services'
[[ -x /etc/init.d/nginx ]] && sudo /etc/init.d/nginx reload || sudo /usr/bin/systemctl reload nginx.service
echo '...done'
echo '+Reconfigure crontab'

crontab -l | grep -v -E '^SHELL=' | grep -v '#'$PROJECT'$' > $TMP_DIR/.crontab.tmp
(( $(cat $TMP_DIR/.crontab.tmp | wc -l) > 0)) && sed -i '1i SHELL=/bin/bash' $TMP_DIR/.crontab.tmp || echo 'SHELL=/bin/bash' > $TMP_DIR/.crontab.tmp
echo '* * * * * source ~/.kissrc ; kiss '$PROJECT' ; run > $TMP_DIR/run.log ; #'$PROJECT >> $TMP_DIR/.crontab.tmp
crontab $TMP_DIR/.crontab.tmp
/bin/rm $TMP_DIR/.crontab.tmp
echo '...done'

echo '+Running init-app script'
[[ -x $BIN_DIR/init-app ]] && $BIN_DIR/init-app
echo '...done'
