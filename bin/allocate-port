#!/usr/bin/env bash
if [[ -z $1 ]]; then
  echo 'Usage: allocate-port name'
  exit 1
fi
port_file=$HOME/ports
test ! -f $port_file && touch $_

max=33000
for line in `cat $port_file`; do
  port=${line##*:}
  if (( $max < $port )); then
    max=$port
  fi
done
port=$(( $max + 1 ))

line=$(cat $port_file | grep -E "^$PROJECT:$1\:[0-9]+$")
if [[ -z $line ]]; then
  echo "$PROJECT:$1:$port" >> $port_file
  cat $port_file | sort -h > $_
  mv $port_file.tmp $port_file
else
  port=${line##*:}
fi
echo $port
