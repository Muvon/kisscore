#!/usr/bin/env bash
if [[ -z $1 ]]; then
  echo 'Usage: allocate-port name'
  return
fi
[[ ! -f ~/ports ]] && touch ~/ports

start=33000
max=33000
for line in `cat ~/ports`; do
  port=${line##*:}
  if (( $max < $port )); then
    max=$port
  fi
done
port=$(( $max + 1 ))

line=$(cat ~/ports | grep -E ^$PROJECT:$1\:[0-9]+$)
if [[ -z $line ]]; then
  echo "$PROJECT:$1:$port" >> ~/ports
  cat ~/ports | sort -h > ~/ports.tmp
  mv ~/ports.tmp ~/ports
else
  port=${line##*:}
fi
echo $port
