#!/usr/bin/env bash
set -e

# shellcheck source=./env.sh
source "$(dirname $0)/../env.sh"

timeout="${2:-0}"
if [[ -z "$1" ]]; then
  >&2 echo 'Usage bin/cron [path-to-executable] [timeout]'
  exit 1
fi

file="$PROJECT_DIR/$1"
if [[ ! -f "$file" || ! -x "$file" ]]; then
  >&2 echo "File should exists and be executable (chmod 700): $file"
  exit 1
fi

while true; do
  ts="$(date +%s)"
  "$file"
  job_time=$(( $(date +%s) - ts ))
  datetime="$(date +%Y-%m-%d\ %T)"
  echo "[$datetime] Job took ${job_time}s"
  if (( timeout > 0 )); then
    echo "[$datetime] Waiting ${timeout}s"
    sleep "$timeout"
  fi
done
