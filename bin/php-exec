#!/usr/bin/env bash
[[ -z "$PROJECT" ]] && echo 'Not in project. Use "kiss PROJECT" first' && exit 1
[[ -z "$1" ]] && echo 'Usage: php-exec [code | php_file]' && exit 1
php=$(which php)
config=$($php --ini | head -n 1)
config=${config##* }

OPTS=''
if [[ -f $config ]]; then
  OPTS='-c '$config
fi
code=$(test -f "$1" && echo "include '$1'" || echo "$1");
$php $OPTS <<EOF
<?php
  include getenv('KISS_CORE');

  // Получаем ответ   и выполняем запрос
  try {
    App::start();
    $code;
    App::stop();
  } catch (Exception \$E) {
    echo 'Error: ' . \$E->getMessage() . PHP_EOL . 'More info: tail -f $LOG_DIR/' . gmdate('Ymd') . '-error.log';
  }
EOF
echo
